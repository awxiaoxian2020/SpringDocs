让我们来设计一个即时消息服务，比如：Facebook Messenger，用户可以通过网页应用或者手机应用互相发送文本信息。

== 1. 什么是Facebook Messenger？

Facebook Messenger是一个软件应用程序，它给它的用户提供了基于文本信息的即时消息服务。Messenger用户可以通过facebook网站以及手机端应用与他们的朋友聊天。

== 2. 系统的需求和目标

我们的Messenger需要满足以下要求：

==== 功能性需求：

<1> Messenger应该支持用户之间一对一会话。
<2> Messenger应该保持用户状态（在线/离线）展示。
<3> Messenger应该支持聊天记录的持久化存储。

==== 非功能性需求：

<1> 用户应该具有最小延迟的实时聊天体验。
<2> 我们的系统应该高一致性；用户应该能够看到他们相同的聊天记录在他们所有的设备上。
<3> Messenger的高可用是需要的；我们可以为了消息的一致性，容忍较小的可用性。

==== 拓展性需求:

 * 组聊天：Messenger应该支持多用户在同一个群组中互相聊天。
 * 通知推送：Messenger应该能够在用户离线的情况下通知用户有一条新消息。

== 3.容量预估以及约束

假设我们有5亿日活量用户以及每天平均每个用户发送40条消息；这样我们每天就需要存储200亿条消息。

存储容量预估：假设平均每条消息占用100 bytes，所以每天存储所有的消息，我们需要2TB的存储容量。

`200亿条消息 * 100 bytes => 2TB/天`

存储5年的聊天记录，我们就需要3.6 PB的存储容量。

`2TB * 365天 * 5年 ~= 3.6PB`

除了这些聊天记录，我们也需要存储用户的信息，消息元数据（ID，时间戳（Timestamp）等等）。

更何况上述计算没有考虑数据压缩以及复制的情况。

*带宽预估：* 如果我们的服务每天收到2TB的数据，这将需要我们提供25MB/s的上传数据的速度。

2TB / 86400秒 ~= 25MB/s

因为每条上传的消息需要我们发送给另一个用户，所以我们需要相同带宽（25MB/s）用于消息的上传和下载。

*高级预估：*

每天总量200亿条消息、每天2TB数据存储、五年3.6PB数据存储、上传数据速度25MB/s、下载数据速度25MB/s

== 4.高级设计

从高层面来讲，我们需要一个聊天服务器作为中心部分，协调用户之间的所有通信。当用户想给另一个用户发送消息时，他们需要连接到聊天服务器并且发送消息给服务器；然后服务器将这个消息发送给另一个用户并且也将内容存储在数据库中。

image::image-2021-09-12-23-14-18-731.png[align=center]
详细工作流程如下所示：

<1> 用户A通过聊天服务器发送一条消息给用户B
<2> 服务器接收到消息并且向用户B发送一个ACK确认
<3> 服务器将消息存储到数据库.并且将这条消息发送给用户B
<4> 用户B接收到消息并向服务器发送ACK确认
<5> 服务器通知用户A，消息已经成功发送给用户B

发送消息的请求流程

== 5. 组件详细设计

首先让我尝试构建一个简单的解决方案，所有服务运行在一台服务器上，在高级别用例中，我们系统需要解决以下问题:

<1> 接收消息和发送消息；
<2> 存储消息到数据库以及从数据库中检索信息；
<3> 记录用户对的在线和离线状态，并且通知所有与该用户相关的用户状态的变化。

