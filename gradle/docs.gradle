
apply plugin: "org.asciidoctor.jvm.convert"
apply plugin: "org.asciidoctor.jvm.pdf"

ext{
	language = "zh-cn"
	component = project.name
	version = project.version
}
configurations {
	asciidoctorExt
}

dependencies {
	asciidoctorExt("io.spring.asciidoctor:spring-asciidoctor-extensions:0.2.0.RELEASE")
}

task extractDocResources(type: Copy) {
	from "${rootDir}/spring-docs-build/src/main/resources"
	into "$buildDir/docs/spring-docs-resources"
}

asciidoctorj {
	modules {
		pdf {
			version '1.5.0-beta.8'
		}
	}
}

asciidoctor {
	baseDir "${sourceDir}/${language}"
	configurations 'asciidoctorExt'
	sources {
		include "${language}/*.adoc"
	}
	outputDir "$buildDir/docs/ref-docs/"
	resources {
		from(sourceDir) {
			include "${language}/images/*"
		}
	}
	logDocuments = true

	outputs.upToDateWhen { false }
	outputOptions {
		backends = ["html5", "pdf"]
	}

	options doctype: 'book', eruby: 'erubis'
	attributes([
			// base attributes
			//'pdf-fontsdir': file("${rootProject.projectDir}/data/fonts"),
			//'pdf-stylesdir': file("${rootProject.projectDir}/data/themes"),
//			'pdf-style': 'basic',
			'idprefix' : "",
			'idseparator' : "-",
			'toc' : "left",
			'toclevels' : 4,
			'tabsize' : 4,
			'numbered' : "",
			'source-indent':0,
			'sectanchors' : "",
			'sectnums' : "",
			'icons' : "font",
			'hide-uri-scheme' : "font",
			'docinfo':"shared,private",
			'highlightjs-theme': "github",
			'allow-uri-read':"*.adoc",
			'highlightjsdir' : "http://resources.jcohy.com/js/highlight",
			'sourceHighlighter' : "highlight.js",
			'stylesdir': "$buildDir/docs/spring-docs-resources/css",
			'stylesheet' : "stylesheet.css",

			//project
			'rootProject': "${rootProject.projectDir}",
			// resource attributes
			'doc-root' : "${docsRoot}",
			'sources-root':"${project.projectDir}/src",
			'image-resource': "http://resources.jcohy.com/jcohy-docs/images/${springBootVersion}/${project.name}",
			'image-dir': "http://resources.jcohy.com/jcohy-docs/images/${project.name}",

			// version attributes
			'spring-framework-version' : "${springVersion}",
			'spring-boot-version' : "${springBootVersion}",
			'spring-data-jpa-version' : "${springDataJpaVersion}",
			'spring-data-redis-version' : "${springDataRedisVersion}",
			'spring-data-rest-version' : "${springDataRestVersion}",
			'spring-data-commons-version' : "${springDataCommonsVersion}",
			'spring-security-version' : "${springSecurityVersion}",
			'spring-hateoas-version' : "${springHateoasVersion}",
			'gradle-version':"${gradleVersion}",
			'reactor-version' : "${reactorVersion}",
			'rfc-version' : "${rfcDocsVersion}",
			'checkstyle-version' : "${checkStyleVersion}",
			'spring-cloud-version' : "${springCloudVersion}",
			'spring-integration-version' : "${springIntegrationVersion}",
			'spring-webservices-version' : "${springWebservicesVersion}",

			// docs attributes
			'spring-docs-prefix' : "https://docs.spring.io/spring-framework/docs/",
			'spring-boot-docs' : "https://docs.spring.io/spring-boot/docs/",
			'spring-framework-docs' : "${docsRoot}/zh-cn/spring-framework/${springVersion}/spring-framework-reference/index.html",
			'spring-api-doc':"https://docs.spring.io/${project.name}",

			// sample attributes
			'gh-samples-url':"https://github.com/spring-projects/spring-security/master/${springSecurityVersion}/samples",
	])
}

//asciidoctorPdf {
//	logDocuments true
//
//	sources {
//		include "${language}/*.adoc"
//	}
//	baseDirFollowsSourceDir()
//
//	// 强制每次都重新生成
//	outputs.upToDateWhen { false }
//
//	fontsDir file("${rootProject.projectDir}/data/fonts")
////     theme 'KaiGenGothicCN'
//	theme 'SourceHanSerifCN'
//}

//pdfThemes {
//	// 思源黑体
////	local 'basic', {
////		styleDir = file("${rootProject.projectDir}/data/themes")
////		styleName = 'very-basic'
////	}
//	// 思源宋体
//	local 'SourceHanSerifCN', {
//		styleDir = file("${rootProject.projectDir}/data/themes")
//		styleName = 'SourceHanSerifCN'
//	}
//}

asciidoctor.dependsOn extractDocResources

task docsCopy(type: Copy,dependsOn:asciidoctor ) {
	from "$asciidoctor.outputDir"
	into "${rootDir}/build/docs/${component}/${version}"
}

//docsCopy.dependsOn asciidoctor